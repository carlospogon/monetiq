<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONETIQ | Your spending, understood.</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- CDNs -->
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- PDF.js for PDF processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="app-container">
        <!-- Sidebar / Navigation -->
        <aside class="sidebar">
            <div class="logo" style="flex-direction: column; align-items: flex-start; gap: 0.2rem;">
                <h2 style="font-size: 1.5rem; letter-spacing: -0.03em;">MONETIQ</h2>
                <span class="tagline" style="
                    background: none;
                    -webkit-text-fill-color: var(--text-secondary);
                    font-size: 0.75rem;
                    text-transform: none;
                    font-weight: 400;
                    letter-spacing: 0;
                    opacity: 0.8;
                ">Your spending, understood.</span>
            </div>
            <nav>
                <button class="nav-btn active" data-target="dashboard-view">
                    <span class="icon">üìä</span> Dashboard
                </button>
                <button class="nav-btn" data-target="analytics-view">
                    <span class="icon">üîÆ</span> Analytics PRO
                </button>
                <button class="nav-btn" data-target="upload-view">
                    <span class="icon">üßæ</span> Analizar Ticket
                </button>
                <button class="nav-btn" data-target="history-view">
                    <span class="icon">üïí</span> Hist√≥rico
                </button>
                <button class="nav-btn" data-target="shopping-view">
                    <span class="icon">üõí</span> Lista Compra
                </button>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">

            <!-- VIEW: DASHBOARD -->
            <section id="dashboard-view" class="view active">
                <header class="view-header">
                    <h1>Resumen de Gastos</h1>
                    <select id="dashboard-merchant-selector" class="nav-select"
                        style="max-width: 200px; padding: 5px 10px; border-radius: 8px; background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border);">
                        <option value="">Todos los comercios</option>
                    </select>
                </header>

                <!-- Heatmap Module -->
                <div id="heatmap-section" style="margin-bottom: 2rem;">
                    <h3>üß† H√°bitos de Compra</h3>
                    <div id="heatmap-container">
                        <!-- Heatmap Rendered Here -->
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Gasto Total</h3>
                        <p class="stat-value" id="total-expense">0.00 ‚Ç¨</p>
                    </div>
                    <div class="stat-card">
                        <h3>Tickets</h3>
                        <p class="stat-value" id="total-tickets">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Top Categor√≠a</h3>
                        <p class="stat-value" id="top-category">-</p>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-box">
                        <h3>Gasto por Categor√≠a</h3>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-box">
                        <h3>Top Productos Caros</h3>
                        <ul id="top-expensive-list" class="top-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                    <div class="chart-box" style="grid-column: span 2;">
                        <!-- Using span 2 to make it wide if grid is 2 cols -->
                        <h3>üõí Productos Probables Pr√≥xima Compra</h3>
                        <div id="next-purchase-insights"
                            style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem; font-style: italic;">
                            <!-- Insights here -->
                        </div>
                        <ul id="next-purchase-list" class="top-list prediction-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>

                    <!-- Price Variation Panel (Moved to Dashboard) -->
                    <div class="chart-box" id="price-variation-box" style="grid-column: span 2; margin-top: 1rem;">
                        <h3>üí∏ An√°lisis de Variaci√≥n de Precios</h3>
                        <div id="price-insights"
                            style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem; font-style: italic;">
                            <!-- Insights -->
                        </div>
                        <table class="simple-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Antes</th>
                                    <th>Ahora</th>
                                    <th>Variaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="price-variation-list">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: ANALYTICS PRO -->
            <section id="analytics-view" class="view hidden">
                <header class="view-header">
                    <h1>Inteligencia Financiera</h1>
                </header>

                <div class="insights-panel" id="insights-container">
                    <!-- Dynamic Insights -->
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Mes M√°s Caro</h3>
                        <p class="stat-value" id="month-max-spend">-</p>
                        <small id="month-max-name" style="color: #f48771;">-</small>
                    </div>
                    <div class="stat-card">
                        <h3>Mes M√°s Barato</h3>
                        <p class="stat-value" id="month-min-spend">-</p>
                        <small id="month-min-name" style="color: #89d185;">-</small>
                    </div>
                    <div class="stat-card">
                        <h3>Gasto Medio Mensual</h3>
                        <p class="stat-value" id="month-avg-spend">-</p>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Pr√≥xima Compra Est.</h3>
                        <p class="stat-value" id="pred-next-date">-</p>
                        <small id="pred-freq">Basado en tu frecuencia</small>
                    </div>
                    <div class="stat-card">
                        <h3>Proyecci√≥n Mes</h3>
                        <p class="stat-value" id="pred-month-spend">-</p>
                        <small id="pred-month-diff">vs Media</small>
                    </div>
                    <div class="stat-card">
                        <h3>Ticket Medio</h3>
                        <p class="stat-value" id="analytics-avg-ticket">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>Media / Ticket</h3>
                        <div class="stat-value" id="stats-avg-ticket">0.00 ‚Ç¨</div>
                    </div>
                </div>

                <!-- Evolution Panel -->
                <div id="spending-evolution-container"></div>

                <div class="charts-container" style="align-items:start;">
                    <!-- Left: Leak Detector -->
                    <div class="chart-box" id="leak-detector-box">
                        <!-- Rendered by JS -->
                    </div>

                    <!-- Right: Trend Chart -->
                    <div class="chart-box">
                        <h3>Tendencia de Gasto</h3>
                        <div style="height: 250px;">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Previous Next Purchase & Price Variation Panels -->
                <div class="charts-container" style="margin-top:2rem;">
                    <div class="chart-box">
                        <h3>Top Productos Recurrentes</h3>
                        <ul id="recurring-list" class="top-list"></ul>
                    </div>
                </div>
            </section>

            <!-- VIEW: UPLOAD & ANALYZE -->
            <section id="upload-view" class="view hidden">
                <header class="view-header">
                    <h1>Nuevo An√°lisis</h1>
                </header>

                <div class="upload-area" id="drop-zone">
                    <input type="file" id="file-input" accept=".jpg,.jpeg,.png,.pdf" multiple hidden>
                    <div class="upload-content">
                        <span class="upload-icon">‚òÅÔ∏è</span>
                        <h3>Arrastra tus tickets aqu√≠</h3>
                        <p>o haz clic para buscar (Soporta m√∫ltiples archivos)</p>
                    </div>
                </div>

                <!-- Analysis Workspace (Hidden until file loaded) -->
                <div id="workspace" class="workspace hidden">
                    <div class="preview-panel">
                        <img id="image-preview" src="" alt="Ticket Preview">
                        <div id="pdf-preview-info" class="hidden">PDF Cargado</div>
                        <div class="ocr-status" id="ocr-status">Esperando...</div>
                    </div>

                    <div class="data-panel">
                        <div class="panel-header">
                            <h3>Datos Extra√≠dos</h3>
                            <div class="actions">
                                <button class="btn btn-primary" id="save-ticket-btn">Guardar Ticket</button>
                            </div>
                        </div>

                        <div class="ticket-meta">
                            <label>Comercio: <input type="text" id="merchant-input" placeholder="Ej: Mercadona"></label>
                            <label>Fecha: <input type="date" id="date-input"></label>
                            <label>Total: <input type="number" id="total-input" step="0.01"></label>
                        </div>

                        <div class="items-editor">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Precio</th>
                                        <th>Categor√≠a</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="items-table-body">
                                    <!-- Rows generated by JS -->
                                </tbody>
                            </table>
                            <button class="btn btn-small" id="add-row-btn">+ A√±adir L√≠nea</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: HISTORY -->
            <section id="history-view" class="view hidden">
                <header class="view-header">
                    <h2>Hist√≥rico</h2>
                    <button class="btn btn-secondary" id="clear-history-btn"
                        style="background-color: var(--danger); border: 1px solid var(--danger); color: white;">üóëÔ∏è
                        Borrar Todo</button>
                </header>
                <div class="history-list" id="history-list">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- VIEW: SHOPPING LIST -->
            <section id="shopping-view" class="view hidden">
                <header class="view-header">
                    <h1>Lista de la Compra</h1>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-secondary" id="import-ocr-btn"
                            style="background-color: var(--accent); border: 1px solid var(--accent); color: white;">üì•
                            Importar de OCR</button>
                        <button class="btn btn-secondary" id="clear-shopping-btn"
                            style="background-color: var(--danger); border: 1px solid var(--danger); color: white;">üóëÔ∏è
                            Limpiar</button>
                    </div>
                </header>

                <div class="add-item-box">
                    <input type="text" id="shopping-input" placeholder="Ej: Leche, Huevos...">
                    <button class="btn btn-primary" id="add-shopping-btn">A√±adir</button>
                </div>

                <div class="shopping-container">
                    <ul id="shopping-list" class="shopping-list">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </section>

            <!-- MODAL: Insight Details -->
            <div id="insight-modal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2 id="modal-title">Detalle</h2>
                    <p id="modal-desc" class="modal-subtitle">Explicaci√≥n del gasto</p>

                    <div class="modal-body">
                        <ul id="modal-list" class="top-list"></ul>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script type="module" src="js/app.js"></script>
</body>

</html>